#!/usr/bin/env node
'use strict';

var path          = require('path');
var program       = require('commander');
var blessed       = require('blessed');
var bootstrap     = require('../src/bootstrap');
var UserInterface = require('../src/ui');
var Application   = require('../src/app/main');
var configFile    = path.resolve(process.env.HOME, './.qi.json');
var cacheFile     = path.resolve(process.env.HOME, './.qi-cache.json');

program
  .version('2.0.0')
  .option('--clear-cache', 'Clears the cache')
  .option('--init', 'Setup qissues for the first time')
  .option('-v --verbose', 'Verbosity (increase verbosity with more vs)', function(add, level) {
    return level + 1;
  }, 0)
  .parse(process.argv);

process.title = 'qissues';

var logger = require('../src/services/logger')(program.verbose || 0);
var container = bootstrap(configFile, cacheFile);
container.listServices().forEach(function(service) {
  container.get(service).logger = logger;
});
container.registerService('logger', function() {
  return require('../src/services/logger')(program.verbose || 0);
});

container.get('config')
  .then(function() {
    if(program.clearCache) {
      return container.get('cache').then(function(cache) {
        cache.invalidateAll();
      });
    }
  })
  .then(function() {
    return new Application(container);
  })
  .then(function(app) {
    if (program.init) {
      return app.configure().then(function() {
        process.exit(0);
      });
    }
    return app;
  })
  .then(function(app) {
    app.start(new UserInterface(process.stdin, process.stdout));
    app.exit = process.exit;
  });
